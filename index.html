<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="manifest" href="manifest.json" />
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <title>Weather App</title>

    <!-- bootstrap and boostrap icons css cdns -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
</head>

<!-- custom css -->
<style>
    .bg-day {
        background-image: linear-gradient(#32699F, #7cb1e7);
    }

    .bg-night {
        background-image: linear-gradient(#00022A, #4b5673);
    }

    .card {
        border-radius: 32px;
    }

    /* fix color scheme, add night/day colors? */
    #frmWidget {
        background-color: #B2DFFB;
    }

    .inner-card {
        background-color: #D3F4FF;
        border-radius: 40px;
    }

    .selector {
        background-color: #B2DFFB;
        border-radius: 40px;
    }

    .bi {
        font-size: 30px;
    }

    p {
        font-size: 0.8rem;
    }
</style>

<body class="bg-day">
    <div class="d-flex min-vh-100 justify-content-center align-items-center">
        <div class="card col-10 col-sm-10 col-md-6 col-lg-4" id="frmWidget">
            <div class="card-body text-center p-3">
                <!-- top card -->
                <div class="card inner-card mb-2">
                    <div class="card-body">
                        <div class="row">
                            <h6 id="txtLocation"></h6>
                        </div>
                        <div class="row align-items-around">
                            <div class="col">
                                <i id="iconTemp"></i>
                                <h6 id="txtTemp"></h6>
                            </div>
                            <div class="col">
                                <i id="iconCondition"></i>
                                <h6 id="txtCondition"></h6>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 2nd card -->
                <div class="card inner-card mb-2">
                    <div class="card-body">
                        <div class="row d-flex justify-content-center align-items-center">
                            <div class="col">
                                <h6 id="txtHighTemp" class="mb-3"></h6>
                                <h6 id="txtLowTemp"></h6>
                            </div>
                            <div class="col">
                                <h6 id="txtHumidityHeader"></h6>
                                <h6 id="txtHumidity"></h6>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- apex charts -->
                <div class="card inner-card">
                    <div class="card-body">
                        <select class="form-select selector mb-1" id="selChart" aria-label="Select a chart">
                            <option value="temperature">Temperature</option>
                            <option value="humidity">Humidity</option>
                            <option value="precipitation">Precipitation</option>
                            <option value="wind">Wind</option>
                        </select>
                        <div id="chart"></div>
                    </div>
                </div>
                <p class="mt-3 mb-0">Made with <a href="https://open-meteo.com/en/docs">Open-Meteo API</a></p>
            </div>
        </div>
    </div>
    <!-- footer to acknowledge the api -->

    <!-- bootstrap and swwet alert cdns -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- vanilla js -->
    <script>
        // get user's location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (location) {
                populateHTML(location.coords.latitude, location.coords.longitude)
            }, function (error) {

                // future: if no location, default to using device IP???

                // alert user to enable location sharing if denied
                if (error.code === error.PERMISSION_DENIED) {
                    Swal.fire({
                        title: "Don't know where you are, silly!",
                        text: "Please enable location sharing in your settings!",
                        icon: 'error'
                    })
                } else {
                    Swal.fire({
                        title: "Oh no, an error occurred!",
                        text: "There was an issue getting your location",
                        icon: 'error'
                    })
                }
            })
        }

        // function that populates data into the html
        async function populateHTML(latitude, longitude) {
            let strWeatherApiUrl = `https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current=temperature_2m,relative_humidity_2m,is_day,precipitation,weather_code&hourly=temperature_2m,relative_humidity_2m,precipitation_probability,wind_speed_10m,wind_direction_10m&daily=temperature_2m_max,temperature_2m_min&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=auto&forecast_days=1`
            let strGeocodingApiUrl = `https://nominatim.openstreetmap.org/reverse.php?lat=${latitude}&lon=${longitude}&zoom=10&format=json`
            console.log(strWeatherApiUrl)
            // make api calls
            const objWeatherData = await getData(strWeatherApiUrl)
            const objGeocodeData = await getData(strGeocodingApiUrl)

            // get all necessary data
            const objCurrent = objWeatherData.current
            const objDaily = objWeatherData.daily
            const objHourly = objWeatherData.hourly

            // get city and state
            const strCity = objGeocodeData.name
            let strState = objGeocodeData.address.state
            // get state abbreviation if in the US
            if (objGeocodeData.address.country === "United States") {
                strState = getStateAbbr(strState)
            }

            const strTempUnit = objWeatherData.current_units.temperature_2m
            const strHumidityUnit = objWeatherData.current_units.relative_humidity_2m
            const boolIsDay = objCurrent.is_day
            const fltCurrTemp = objCurrent.temperature_2m
            const intCurrHumidity = objCurrent.relative_humidity_2m
            const intCurrWeatherCode = objCurrent.weather_code
            const fltDailyTempMax = objDaily.temperature_2m_max[0]
            const fltDailyTempMin = objDaily.temperature_2m_min[0]

            // get specific icons based on data
            const objConditions = getConditionAndIcon(intCurrWeatherCode, boolIsDay)
            const strTempIcon = getTempIcon(fltCurrTemp)

            // change bg colors based on day/night
            if (boolIsDay) {
                document.querySelector('body').className = "bg-day"
            } else {
                document.querySelector('body').className = "bg-night"
            }

            // input all data into the html
            document.querySelector('#txtLocation').innerHTML = strCity + ", " + strState
            document.querySelector('#iconTemp').className = strTempIcon
            document.querySelector('#txtTemp').innerHTML = fltCurrTemp + strTempUnit
            document.querySelector('#iconCondition').className = objConditions.icon
            document.querySelector('#txtCondition').innerHTML = objConditions.condition
            document.querySelector('#txtHighTemp').innerHTML += 'High: ' + fltDailyTempMax + strTempUnit
            document.querySelector('#txtLowTemp').innerHTML += 'Low: ' + fltDailyTempMin + strTempUnit
            document.querySelector('#txtHumidityHeader').innerHTML = 'Humidity'
            document.querySelector('#txtHumidity').innerHTML += intCurrHumidity + strHumidityUnit

            console.log(objHourly)
            renderChart(objHourly)

        }

        function renderChart(objData) {
            console.log(objData.temperature_2m, objData.time)
            const chartData = {
                temperature: {
                    name: 'Temperature',
                    data: objData.temperature_2m
                },
                humidity: {
                    name: 'Humidity',
                    data: objData.relative_humidity_2m
                },
                precipitation: {
                    name: 'Precipitation',
                    data: objData.precipitation_probability
                },
                windSpeed: {
                    name: 'Wind',
                    data: objData.wind_speed_10m
                }
            }

            const options = {
                series: [{
                    name: chartData.temperature.name,
                    data: chartData.temperature.data
                }],
                chart: {
                    height: 250,
                    type: 'area',
                    background: '#D3F4FF',
                    toolbar: {
                        show: false
                    },
                    zoom: {
                        enabled: false
                    }
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth'
                },
                xaxis: {
                    type: 'datetime',
                    categories: objData.time
                },
                tooltip: {
                    x: {
                        format: 'dd HH:mm'
                    },
                },
            }

            var chart = new ApexCharts(document.querySelector("#chart"), options)
            chart.render()
        }


        async function getData(strApiUrl) {
            const objResponse = await fetch(strApiUrl, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })

            if (!objResponse.ok) {
                throw new Error('HTTP Error Status', objResponse.status)
            }

            const objData = await objResponse.json()
            return objData
        }

        function getTempIcon(temp) {
            let icon = ""
            if (temp > 80) {
                icon = "bi bi-thermometer"
            } else if (temp > 60) {
                icon = "bi bi-thermometer-half"
            } else if (temp > 30) {
                icon = "bi bi-thermometer-low"
            } else {
                icon = "bi bi-thermometer"
            }

            return icon
        }

        function getConditionAndIcon(weatherCode, isDay) {
            let condition = ""
            let icon = ""
            switch (weatherCode) {
                case 0:
                    if (isDay) {
                        condition = "Sunny"
                        icon = "bi bi-sun"
                    } else {
                        condition = "Clear"
                        icon = "bi bi-moon-stars"
                    }
                    break
                case 1:
                    if (isDay) {
                        condition = "Mostly Sunny"
                        icon = "bi bi-sun"
                    } else {
                        condition = "Mostly Clear"
                        icon = "bi bi-moon"
                    }
                    break
                case 2:
                    if (isDay) {
                        condition = "Partly Cloudy"
                        icon = "bi bi-cloud-sun"
                    } else {
                        condition = "Partly Cloudy"
                        icon = "bi bi-cloud-moon"
                    }
                    break
                case 3:
                    condition = "Overcast"
                    icon = "bi bi-cloudy"
                    break
                case 45:
                    condition = "Fog"
                    icon = "bi bi-cloud-fog2"
                    break
                case 48:
                    condition = "Rime Fog"
                    icon = "bi bi-cloud-fog2"
                    break
                case 51:
                    condition = "Light Drizzle"
                    icon = "bi bi-cloud-drizzle"
                    break
                case 53:
                    condition = "Drizzle"
                    icon = "bi bi-cloud-drizzle"
                    break
                case 55:
                    condition = "Heavy Drizzle"
                    icon = "bi bi-cloud-drizzle"
                    break
                case 56:
                    condition = "Light Freezing Drizzle"
                    icon = "bi bi-cloud-drizzle"
                    break
                case 57:
                    condition = "Heavy Freezing Drizzle"
                    icon = "bi bi-cloud-drizzle"
                    break
                case 61:
                    condition = "Light Rain"
                    icon = "bi bi-cloud-rain"
                    break
                case 63:
                    condition = "Rain"
                    icon = "bi bi-cloud-rain"
                    break
                case 65:
                    condition = "Heavy Rain"
                    icon = "bi bi-cloud-rain-heavy"
                    break
                case 66:
                    condition = "Light Freezing Rain"
                    icon = "bi bi-cloud-sleet"
                    break
                case 67:
                    condition = "Heavy Freezing Rain"
                    icon = "bi bi-cloud-sleet"
                    break
                case 71:
                    condition = "Light Snowfall"
                    icon = "bi bi-cloud-snow"
                    break
                case 73:
                    condition = "Snow"
                    icon = "bi bi-cloud-snow"
                    break
                case 75:
                    condition = "Heavy Snow"
                    icon = "bi bi-cloud-snow"
                    break
                case 77:
                    condition = "Snow Grains"
                    icon = "bi bi-cloud-snow"
                    break
                case 80:
                    condition = "Light Rain Shower"
                    icon = "bi bi-cloud-rain"
                    break
                case 81:
                    condition = "Rain Shower"
                    icon = "bi bi-cloud-rain"
                    break
                case 82:
                    condition = "Heavy Rain Shower"
                    icon = "bi bi-cloud-rain-heavy"
                    break
                case 85:
                    condition = "Light Snow Shower"
                    icon = "bi bi-cloud-snow"
                    break
                case 86:
                    condition = "Heavy Snow Shower"
                    icon = "bi bi-cloud-snow"
                    break
                case 95:
                    condition = "Thunderstorm"
                    icon = "bi bi-cloud-lightning-rain"
                    break
                case 96:
                    condition = "Light Hail Thunderstorm"
                    icon = "bi bi-cloud-lightning-rain"
                    break
                case 99:
                    condition = "Heavy Hail Thunderstorm"
                    icon = "bi bi-cloud-lightning-rain"
                    break
                default:
                    condition = "Unknown"
            }
            return {"condition": condition, "icon": icon}
        }

        function getStateAbbr(state) {
            const stateMapping = {
                "Alabama": "AL",
                "Alaska": "AK",
                "Arizona": "AZ",
                "Arkansas": "AR",
                "California": "CA",
                "Colorado": "CO",
                "Connecticut": "CT",
                "Delaware": "DE",
                "District Of Columbia": "DC",
                "Florida": "FL",
                "Georgia": "GA",
                "Hawaii": "HI",
                "Idaho": "ID",
                "Illinois": "IL",
                "Indiana": "IN",
                "Iowa": "IA",
                "Kansas": "KS",
                "Kentucky": "KY",
                "Louisiana": "LA",
                "Maine": "ME",
                "Maryland": "MD",
                "Massachusetts": "MA",
                "Michigan": "MI",
                "Minnesota": "MN",
                "Mississippi": "MS",
                "Missouri": "MO",
                "Montana": "MT",
                "Nebraska": "NE",
                "Nevada": "NV",
                "New Hampshire": "NH",
                "New Jersey": "NJ",
                "New Mexico": "NM",
                "New York": "NY",
                "North Carolina": "NC",
                "North Dakota": "ND",
                "Ohio": "OH",
                "Oklahoma": "OK",
                "Oregon": "OR",
                "Pennsylvania": "PA",
                "Rhode Island": "RI",
                "South Carolina": "SC",
                "South Dakota": "SD",
                "Tennessee": "TN",
                "Texas": "TX",
                "Utah": "UT",
                "Vermont": "VT",
                "Virginia": "VA",
                "Washington": "WA",
                "West Virginia": "WV",
                "Wisconsin": "WI",
                "Wyoming": "WY"
            };

            return stateMapping[state]
        }
    </script>
</body>

</html>